'use strict';

// Script for HTML map of superpowered people per location.
// About the Parahumans fictional universe created by Wildbow.

// npm run buildPopGrid

const Util = require('../../../../util/util.js');

// // const GeoTIFF = require('geotiff');
// // import GeoTIFF from 'geotiff';
// import { fromFile } from 'geotiff';
// import { dirname } from 'path';
// import { fileURLToPath } from 'url';

// Using world population data from: https://hub.worldpop.org/geodata/summary?id=24777
// DOI : 10.5258/SOTON/WP00647

class CapeMap {
    constructor () {
        this.init();
    }

    init () {
        if (window) {
            window.canvas = document.getElementById('canvas');

            window.ctx = window.canvas.getContext('2d');

            this.setHtml();
        }
    }

    /*
    {
        0: [array of length 808704000],
        length: 1,
        width: 43200,
        height: 18720,
    }
    */

    box2rgba (array2d) {
        const rgba = [];
        const MAX = 5071;

        for (let row of array2d) {
            for (let pop of row) {
                
                // Water can be #001795
                const colorVal = pop >= 0 ?
                    255 - Math.floor(pop / MAX * 255) :
                    255;

                rgba.push(colorVal);
                rgba.push(colorVal);
                rgba.push(colorVal);
                rgba.push(255);
            }
        }

        return rgba;
    }

    setHtml () {
        window.ctx.clearRect(0, 0, window.canvas.width, window.canvas.height);

        const box = CapeMap.exampleBox();
        const imageData = window.ctx.getImageData(0, 0, box[0].length, box.length);

        imageData.data.set(
            new Uint8ClampedArray(
                this.box2rgba(box)
            )
        );

        window.ctx.putImageData(imageData, 0, 0);
    }

    /*
    Select a box from rasters (to save space) (eg top left)
    Equatorial is x = 9320 to 9360, y = 35520 to 35560
    Print it comma-separated for later fast testing.
    Convert to flat rgba array
        ie, each number turns into 4 numbers
        A, transparency, can be 255 always
    Have a func to write to html canvas
    Call it on html page load
    var palette = ctx.getImageData(0,0,160,120); //x,y,w,h
    palette.data.set(new Uint8ClampedArray(rgbaArray));
    ctx.putImageData(palette,0,0);

    https://stackoverflow.com/questions/15908179/draw-image-from-pixel-array-on-canvas-with-putimagedata
    */

    // one-off utility func.
    tidyCachedBox () {
        const oldBox = CapeMap.exampleBox();
        const newBox = [[]];

        for (let x = 0; x < oldBox.length; x++) {
            for (let y = 1; y < oldBox[x].length; y++) {
                const oldVal = oldBox[x][y];

                const newVal = oldVal < -999 ?
                    -1 :
                    Util.round(oldVal);

                newBox[x].push(newVal);
            }

            newBox.push([]);
        }

        Util.logDebug(newBox);
    }

    // One-off utility func.
    boxInfo () {
        const box = CapeMap.exampleBox();

        let max = -1;
        for (let row of box) {
            for (let pop of row) {
                if (pop > max) {
                    max = pop;
                }
            }
        }

        Util.logDebug({
            max,
        });
    }

    static exampleBox () {
        return [
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                9,
                33,
                60,
                70
            ],
            [
                125,
                73,
                134,
                147,
                166,
                217,
                221,
                162,
                188,
                284,
                360,
                263,
                129,
                119,
                92,
                123,
                110,
                56,
                40,
                26,
                28,
                27,
                26,
                30,
                32,
                37,
                38,
                29,
                31,
                45,
                45,
                57,
                39,
                28,
                23,
                22,
                22,
                24,
                25,
                22
            ],
            [
                22,
                24,
                32,
                49,
                83,
                72,
                47,
                39,
                39,
                34,
                29,
                28,
                26,
                27,
                28,
                27,
                24,
                20,
                18,
                14,
                13,
                15,
                17,
                18,
                16,
                17,
                17,
                15,
                12,
                11,
                7,
                6,
                4,
                4,
                3,
                3,
                2,
                2,
                2,
                2
            ],
            [
                3,
                3,
                3,
                3,
                3,
                3,
                3,
                3,
                3,
                4,
                4,
                5,
                5,
                5,
                5,
                6,
                6,
                6,
                7,
                7,
                7,
                7,
                8,
                10,
                12,
                14,
                13,
                13,
                13,
                13,
                12,
                12,
                13,
                13,
                12,
                12,
                13,
                13,
                13,
                12
            ],
            [
                14,
                13,
                12,
                12,
                13,
                13,
                14,
                14,
                15,
                19,
                21,
                18,
                15,
                15,
                12,
                12,
                12,
                12,
                12,
                10,
                9,
                8,
                8,
                9,
                9,
                8,
                9,
                9,
                11,
                12,
                11,
                11,
                9,
                8,
                6,
                4,
                4,
                4,
                5,
                4
            ],
            [
                6,
                3,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                161,
                84,
                88,
                90,
                101,
                228,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                26,
                7,
                5,
                7,
                19,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                51,
                49,
                -1,
                -1,
                -1,
                2,
                7,
                -1,
                -1,
                -1,
                -1,
                -1,
                217,
                62,
                51,
                36,
                21,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                226,
                54,
                50,
                50,
                28,
                31,
                30,
                25,
                26,
                22,
                21,
                21
            ],
            [
                26,
                46,
                42,
                37,
                35,
                34,
                33,
                33,
                32,
                15,
                19,
                30,
                41,
                46,
                64,
                120,
                141,
                141,
                142,
                149,
                154,
                175,
                177,
                172,
                233,
                245,
                261,
                221,
                205,
                160,
                160,
                149,
                127,
                129,
                130,
                124,
                119,
                118,
                111,
                112
            ],
            [
                31,
                23,
                46,
                44,
                21,
                22,
                35,
                43,
                49,
                50,
                53,
                53,
                48,
                41,
                43,
                47,
                61,
                82,
                213,
                243,
                355,
                234,
                259,
                306,
                449,
                635,
                539,
                229,
                191,
                200,
                443,
                984,
                460,
                307,
                533,
                739,
                251,
                96,
                88,
                70
            ],
            [
                136,
                291,
                211,
                238,
                262,
                363,
                565,
                5071,
                2068,
                739,
                443,
                108,
                51,
                62,
                64,
                63,
                66,
                85,
                216,
                225,
                101,
                39,
                24,
                42,
                55,
                60,
                79,
                128,
                75,
                86,
                229,
                316,
                304,
                353,
                360,
                352,
                260,
                205,
                234,
                341
            ],
            [
                410,
                234,
                307,
                754,
                544,
                422,
                330,
                313,
                128,
                83,
                116,
                196,
                156,
                150,
                109,
                81,
                41,
                87,
                130,
                20,
                14,
                49,
                312,
                135,
                19,
                19,
                42,
                70,
                149,
                210,
                184,
                150,
                128,
                139,
                152,
                144,
                402,
                416,
                404,
                195
            ],
            [
                28,
                35,
                43,
                49,
                44,
                44,
                62,
                86,
                92,
                112,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                147,
                177,
                114,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
            [
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1
            ],
        ];
    }

    static async run () {
        const map = new CapeMap();

        Util.logDebug(`Done with test.`);
    }
};

// module.exports = CapeMap;

CapeMap.run();
