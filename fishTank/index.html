<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>
    <script>
const WIDTH = 1200;
const HEIGHT = 700;

// Rough draft example version came from http://labs.phaser.io/edit.html?src=src/physics/arcade/mass%20collision%20test.js
const config = {
    type: Phaser.WEBGL,
    width: WIDTH,
    height: HEIGHT,
    parent: 'phaser-example',
    physics: {
        default: 'arcade',
        arcade: {
            useTree: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

const Individual = new Phaser.Class({
    Extends: Phaser.GameObjects.Image,

    // Constructor
    initialize: function Individual (scene, x, y, spriteName, faction) {
        this.xSpeed = 0;
        this.ySpeed = 0;
        // this.destination = Phaser.Geom.Rectangle.Random(scene.physics.world.bounds);
        this.faction = randomFromObj(Constants.factions);

        if (this.faction === Constants.factions.covenant) {
            Phaser.GameObjects.Image.call(this, scene, 100, y, spriteName);
            this.speed = 0.15;
        }
        else {
            Phaser.GameObjects.Image.call(this, scene, 1000, y, spriteName);
            this.speed = 0.1;
        }

        // TODO store factions as arrays. Choose target from a different faction.
        // BTW the first to be created matches with themself.
        const allSoldiers = soldierGroup.getChildren();
        this.target = randomOf(allSoldiers) || allSoldiers[0];
    },

    // Updates the position each cycle
    update: function (time, delta) {
        this.orient();
        this.x += this.xSpeed * delta;
        this.y += this.ySpeed * delta;
    },

    // Sets xSpeed and ySpeed correctly
    orient: function () {
        if (! this.target) {
            return;
        }

        const dest = this.target;

        // If at destination, stop and relax.
        if (Math.abs(dest.x - this.x) <= 2 && Math.abs(dest.y - this.y) <= 2) {
            this.xSpeed = 0;
            this.ySpeed = 0;
            return;
        }

        this.direction = Math.atan( (dest.x - this.x) / (dest.y - this.y) );

        if (dest.y >= this.y) {
            this.xSpeed = this.speed * Math.sin(this.direction);
            this.ySpeed = this.speed * Math.cos(this.direction);
        }
        else {
            this.xSpeed = -this.speed * Math.sin(this.direction);
            this.ySpeed = -this.speed * Math.cos(this.direction);
        }

        this.rotation = Phaser.Math.Angle.Between(this.x, this.y, dest.x, dest.y) + (Math.PI / 2);
    }
});

let controls;
let player;
let soldierGroup;
let text;

const Constants = {
    factions: {
        unsc: 'unsc',
        covenant: 'covenant'
    }
};

const game = new Phaser.Game(config);

function preload () {
    this.load.path = 'sprites/';
    this.load.image('soldier', 'fishTankSoldier.png');
    this.load.image('crate', 'assets/sprites/crate.png');
}

function release (faction) {
    // Later deploy in team's deployment zone. Perhaps just offscreen.
    // TODO set up deployment zone rectangles instead of the full physics.world.bounds.
    const usncZone = {};
    const covZone = {};

    for (let i = 0; i < 60; i++) {
        const pos = Phaser.Geom.Rectangle.Random(this.physics.world.bounds);

        // Tutorial https://phaser.io/tutorials/making-your-first-phaser-3-game/part3
        const soldier = soldierGroup.create(pos.x, pos.y, 'soldier');

        soldier.setBlendMode(0);
    }

    text.setText('Total: ' + soldierGroup.getLength());
}

function create () {
    const graphics = this.add.graphics();
    graphics.fillStyle(0x000044);

    this.physics.world.setBounds(0, 0, WIDTH, HEIGHT);

    soldierGroup = this.physics.add.group({
        classType: Individual,
        runChildUpdate: true
    });

    // Yikes, looks like im lucky it bound 'this' for me.
    this.time.addEvent({ delay: 500, callback: release.bind(this, Constants.factions.unsc), callbackScope: this});
    this.time.addEvent({ delay: 1000, callback: release.bind(this, Constants.factions.covenant), callbackScope: this});

    cursors = this.input.keyboard.createCursorKeys();

    player = this.physics.add.image(400, 100, 'crate');

    player.setCollideWorldBounds(true);

    this.physics.add.collider(player, soldierGroup);

    text = this.add.text(10, 10, 'Total: 0', { font: '16px Courier', fill: '#ffffff' });
}

function update (time, delta) {
    // See example: http://labs.phaser.io/edit.html?src=src/games/topdownShooter/topdown_combatMechanics.js

    player.setVelocity(0);

    if (cursors.left.isDown)
    {
        player.setVelocityX(-500);
    }
    else if (cursors.right.isDown)
    {
        player.setVelocityX(500);
    }

    if (cursors.up.isDown)
    {
        player.setVelocityY(-500);
    }
    else if (cursors.down.isDown)
    {
        player.setVelocityY(500);
    }
}

// Later import util.js properly. Perhaps Browserify or http-server is suitable.
function randomOf (array) {
    const index = Math.floor(Math.random() * array.length);
    return array[index];
}

function randomFromObj (obj) {
    const key = randomOf(Object.keys(obj));
    return obj[key];
}

    </script>

</body>
</html>